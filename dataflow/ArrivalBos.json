{
	"name": "ArrivalBos",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "BOSarrival",
						"type": "DatasetReference"
					},
					"name": "source1"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "silver_bosDeparture",
						"type": "DatasetReference"
					},
					"name": "sink1",
					"description": "Export data to silver_bosDeparture"
				}
			],
			"transformations": [
				{
					"name": "flatten1",
					"description": "Add columns to map"
				},
				{
					"name": "derivedColumn1"
				},
				{
					"name": "filter1"
				},
				{
					"name": "select1"
				}
			],
			"scriptLines": [
				"source(output(",
				"          type as string,",
				"          status as string,",
				"          departure as (iataCode as string, icaoCode as string, gate as string, delay as integer, scheduledTime as string, estimatedTime as string, actualTime as string, estimatedRunway as string, actualRunway as string, terminal as string),",
				"          arrival as (iataCode as string, icaoCode as string, terminal as string, baggage as string, gate as string, scheduledTime as string, estimatedTime as string, actualTime as string, estimatedRunway as string, actualRunway as string, delay as integer),",
				"          airline as (name as string, iataCode as string, icaoCode as string),",
				"          flight as (number as string, iataNumber as string, icaoNumber as string),",
				"          codeshared as (airline as (name as string, iataCode as string, icaoCode as string), flight as (number as string, iataNumber as string, icaoNumber as string))",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false,",
				"     documentForm: 'documentPerLine',",
				"     partitionBy('hash', 1)) ~> source1",
				"source1 foldDown(unroll(),",
				"     mapColumn(",
				"          departure,",
				"          arrival,",
				"          airline,",
				"          flight,",
				"          codeshared,",
				"          type,",
				"          status,",
				"          dep_iataCode = departure.icaoCode,",
				"          dep_icaoCode = departure.icaoCode,",
				"          dep_gate = departure.gate,",
				"          dep_delay = departure.delay,",
				"          dep_scheduledTime = departure.scheduledTime,",
				"          dep_estimatedTime = departure.estimatedTime,",
				"          dep_actualTime = departure.actualTime,",
				"          dep_estimatedRunway = departure.estimatedRunway,",
				"          dep_actualRunway = departure.actualRunway,",
				"          dep_terminal = departure.terminal,",
				"          arr_iataCode = arrival.iataCode,",
				"          arr_icaoCode = arrival.icaoCode,",
				"          arr_terminal = arrival.terminal,",
				"          arr_baggage = arrival.baggage,",
				"          arr_gate = arrival.gate,",
				"          arr_scheduledTime = arrival.scheduledTime,",
				"          arr_estimatedTime = arrival.estimatedTime,",
				"          arr_actualTime = arrival.actualTime,",
				"          arr_estimatedRunway = arrival.estimatedRunway,",
				"          arr_actualRunway = arrival.actualRunway,",
				"          arr_delay = arrival.delay,",
				"          airline_name = airline.name,",
				"          airline_iataCode = airline.iataCode,",
				"          airline_icaoCode = airline.icaoCode,",
				"          flight_number = flight.number,",
				"          flight_iataNumber = flight.iataNumber,",
				"          flight_icaoNumber = flight.icaoNumber,",
				"          codeshared_airline_name = codeshared.airline.name,",
				"          codeshared_airline_iataCode = codeshared.airline.iataCode,",
				"          codeshared_airline_icaoCode = codeshared.airline.icaoCode,",
				"          codeshared_flight_number = codeshared.flight.number,",
				"          codeshared_flight_iataNumber = codeshared.flight.iataNumber,",
				"          codeshared_flight_icaoNumber = codeshared.flight.icaoNumber",
				"     ),",
				"     partitionBy('hash', 1),",
				"     skipDuplicateMapInputs: false,",
				"     skipDuplicateMapOutputs: false) ~> flatten1",
				"flatten1 derive(flight_duration_minutes = toInteger((toTimestamp(arr_scheduledTime, 'yyyy-MM-dd\\'T\\'HH:mm:ss.SSS') - toTimestamp(dep_scheduledTime, 'yyyy-MM-dd\\'T\\'HH:mm:ss.SSS')) / 60 / 1000),",
				"          departure_scheduledTime_dt = toTimestamp(dep_scheduledTime, 'yyyy-MM-dd\\'T\\'HH:mm:ss.SSS'),",
				"          departure_delay_minutes = toInteger((toTimestamp(dep_actualTime, 'yyyy-MM-dd\\'T\\'HH:mm:ss.SSS') - toTimestamp(dep_scheduledTime, 'yyyy-MM-dd\\'T\\'HH:mm:ss.SSS')) / 60 / 1000),",
				"          airline_name_upper = upper(airline_name),",
				"          flight_number_trimmed = trim(flight_number),",
				"          departure_gate = iif(isNull(dep_gate), 'Unknown', dep_gate),",
				"          actual_departure_time = iif(isNull(dep_actualTime), dep_scheduledTime, dep_actualTime),",
				"          flight_id = concat(airline_iataCode, '_', flight_number, '_', toString(toDate(dep_scheduledTime, 'yyyy-MM-dd\\'T\\'HH:mm:ss.SSS'), 'yyyyMMdd')),",
				"          is_on_time_departure = iif(dep_delay <= 0, true(), false()),",
				"          departure_delay_category = iif(dep_delay <= 15, '0-15 min',",
				"    iif(dep_delay <= 30, '16-30 min', '30+ min'))) ~> derivedColumn1",
				"derivedColumn1 filter(!isNull(flight_id) && !isNull(type)  && !isNull(status)) ~> filter1",
				"filter1 select(mapColumn(",
				"          type,",
				"          status,",
				"          dep_iataCode,",
				"          dep_icaoCode,",
				"          dep_gate,",
				"          dep_delay,",
				"          dep_scheduledTime,",
				"          dep_estimatedTime,",
				"          dep_actualTime,",
				"          dep_estimatedRunway,",
				"          dep_actualRunway,",
				"          dep_terminal,",
				"          arr_iataCode,",
				"          arr_icaoCode,",
				"          arr_terminal,",
				"          arr_baggage,",
				"          arr_gate,",
				"          arr_scheduledTime,",
				"          arr_estimatedTime,",
				"          arr_actualTime,",
				"          arr_estimatedRunway,",
				"          arr_actualRunway,",
				"          arr_delay,",
				"          airline_name,",
				"          airline_iataCode,",
				"          airline_icaoCode,",
				"          flight_number,",
				"          flight_iataNumber,",
				"          flight_icaoNumber,",
				"          codeshared_airline_name,",
				"          codeshared_airline_iataCode,",
				"          codeshared_airline_icaoCode,",
				"          codeshared_flight_number,",
				"          codeshared_flight_iataNumber,",
				"          codeshared_flight_icaoNumber,",
				"          flight_duration_minutes,",
				"          departure_scheduledTime_dt,",
				"          departure_delay_minutes,",
				"          airline_name_upper,",
				"          flight_number_trimmed,",
				"          departure_gate,",
				"          actual_departure_time,",
				"          flight_id,",
				"          is_on_time_departure,",
				"          departure_delay_category",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select1",
				"select1 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     format: 'parquet',",
				"     partitionFileNames:['historialBosArrival'],",
				"     umask: 0022,",
				"     preCommands: [],",
				"     postCommands: [],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     partitionBy('hash', 1)) ~> sink1"
			]
		}
	}
}